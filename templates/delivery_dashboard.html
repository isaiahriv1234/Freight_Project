<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Time Tracking Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        .delivery-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        .performance-grade {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
        }
        .grade-a { color: #27ae60; }
        .grade-b { color: #f39c12; }
        .grade-c { color: #e67e22; }
        .grade-d { color: #e74c3c; }
        .delivery-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-overdue { border-left: 4px solid #e74c3c; }
        .status-today { border-left: 4px solid #f39c12; }
        .status-week { border-left: 4px solid #3498db; }
        .status-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .carrier-performance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .carrier-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .performance-bar {
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .performance-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .performance-excellent { background: #27ae60; }
        .performance-good { background: #f39c12; }
        .performance-poor { background: #e74c3c; }
        .alert-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-high { border-left: 4px solid #e74c3c; }
        .alert-medium { border-left: 4px solid #f39c12; }
        .alert-low { border-left: 4px solid #3498db; }
        .prediction-tool {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="delivery-header">
        <h1>‚è±Ô∏è Delivery Time Tracking</h1>
        <p>Real-time delivery performance monitoring and SLA tracking</p>
        <div class="performance-grade" id="performanceGrade">-</div>
        <div id="overallPerformance">Loading...</div>
    </div>

    <div class="container">
        <!-- Real-Time Delivery Status -->
        <div class="delivery-status" id="deliveryStatus">
            <div class="status-card status-overdue">
                <div class="status-number" id="overdueCount">-</div>
                <div>Overdue Deliveries</div>
            </div>
            <div class="status-card status-today">
                <div class="status-number" id="dueTodayCount">-</div>
                <div>Due Today</div>
            </div>
            <div class="status-card status-week">
                <div class="status-number" id="dueWeekCount">-</div>
                <div>Due This Week</div>
            </div>
        </div>

        <div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
            <!-- Carrier Performance -->
            <div class="card">
                <h3>üöõ Carrier SLA Performance</h3>
                <div class="carrier-performance" id="carrierPerformance">Loading...</div>
            </div>

            <!-- Delivery Prediction Tool -->
            <div class="card">
                <h3>üîÆ Delivery Time Predictor</h3>
                <div class="prediction-tool">
                    <label>Carrier:</label>
                    <select id="predictCarrier" style="width: 100%; margin: 5px 0;">
                        <option value="UPS">UPS</option>
                        <option value="FedEx">FedEx</option>
                        <option value="Ground">Ground</option>
                        <option value="Freight">Freight</option>
                    </select>
                    
                    <label>Order Value: $</label>
                    <input type="number" id="predictValue" value="2500" style="width: 100%; margin: 5px 0;">
                    
                    <button onclick="predictDeliveryTime()" style="width: 100%; margin: 10px 0; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px;">
                        Predict Delivery Time
                    </button>
                    
                    <div id="predictionResult" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Delivery Alerts -->
        <div class="card">
            <h3>üö® Delivery Alerts</h3>
            <div id="deliveryAlerts">Loading alerts...</div>
        </div>

        <!-- Overdue Deliveries Detail -->
        <div class="card">
            <h3>‚ö†Ô∏è Overdue Deliveries</h3>
            <div id="overdueDetails">Loading...</div>
        </div>

        <!-- Monthly Trends -->
        <div class="card">
            <h3>üìà Monthly Delivery Trends</h3>
            <canvas id="deliveryTrendsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let deliveryChart;

        // Load delivery dashboard data
        async function loadDeliveryDashboard() {
            try {
                const response = await fetch('/api/delivery-dashboard');
                const data = await response.json();
                
                // Update performance summary
                updatePerformanceSummary(data.performance_summary);
                
                // Update real-time status
                updateRealTimeStatus(data.real_time_deliveries);
                
                // Update carrier performance
                updateCarrierPerformance(data.performance_summary.carrier_sla_performance);
                
                // Update alerts
                updateDeliveryAlerts(data.delivery_alerts);
                
                // Update overdue details
                updateOverdueDetails(data.real_time_deliveries.overdue_deliveries);
                
                // Update trends chart
                updateTrendsChart(data.monthly_trends);
                
            } catch (error) {
                console.error('Error loading delivery dashboard:', error);
            }
        }

        function updatePerformanceSummary(summary) {
            const gradeElement = document.getElementById('performanceGrade');
            const grade = summary.performance_grade;
            
            gradeElement.textContent = grade;
            gradeElement.className = 'performance-grade grade-' + grade.charAt(0).toLowerCase();
            
            document.getElementById('overallPerformance').innerHTML = `
                <div>Overall On-Time Rate: ${summary.overall_on_time_percentage.toFixed(1)}%</div>
                <div>Average Lead Time: ${summary.overall_avg_lead_time.toFixed(1)} days</div>
            `;
        }

        function updateRealTimeStatus(realTime) {
            document.getElementById('overdueCount').textContent = realTime.total_overdue;
            document.getElementById('dueTodayCount').textContent = realTime.total_due_today;
            document.getElementById('dueWeekCount').textContent = realTime.total_due_this_week;
        }

        function updateCarrierPerformance(carrierPerf) {
            const html = Object.entries(carrierPerf).map(([carrier, perf]) => {
                const performanceClass = perf.on_time_percentage >= 90 ? 'excellent' : 
                                       perf.on_time_percentage >= 80 ? 'good' : 'poor';
                
                return `
                    <div class="carrier-card">
                        <h4>${carrier}</h4>
                        <div>On-Time Rate: ${perf.on_time_percentage.toFixed(1)}%</div>
                        <div class="performance-bar">
                            <div class="performance-fill performance-${performanceClass}" 
                                 style="width: ${perf.on_time_percentage}%"></div>
                        </div>
                        <small>Avg: ${perf.avg_actual_days.toFixed(1)} days (Target: ${perf.sla_target_days} days)</small>
                    </div>
                `;
            }).join('');
            
            document.getElementById('carrierPerformance').innerHTML = html;
        }

        function updateDeliveryAlerts(alerts) {
            if (alerts.length === 0) {
                document.getElementById('deliveryAlerts').innerHTML = '<p>No active delivery alerts</p>';
                return;
            }
            
            const html = alerts.slice(0, 5).map(alert => `
                <div class="alert-item alert-${alert.priority}">
                    <h4>${alert.title}</h4>
                    <p>${alert.description}</p>
                    <small><strong>Action:</strong> ${alert.action_required}</small><br>
                    <small><strong>Impact:</strong> ${alert.impact}</small>
                </div>
            `).join('');
            
            document.getElementById('deliveryAlerts').innerHTML = html;
        }

        function updateOverdueDetails(overdueDeliveries) {
            if (overdueDeliveries.length === 0) {
                document.getElementById('overdueDetails').innerHTML = '<p>No overdue deliveries</p>';
                return;
            }
            
            const html = overdueDeliveries.slice(0, 10).map(delivery => `
                <div class="alert-item alert-high">
                    <strong>PO ${delivery.po_id}</strong> - ${delivery.supplier}<br>
                    <small>Carrier: ${delivery.carrier} | ${delivery.days_overdue} days overdue | $${delivery.order_value.toLocaleString()}</small>
                </div>
            `).join('');
            
            document.getElementById('overdueDetails').innerHTML = html;
        }

        function updateTrendsChart(trends) {
            const ctx = document.getElementById('deliveryTrendsChart').getContext('2d');
            
            if (deliveryChart) {
                deliveryChart.destroy();
            }
            
            deliveryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.months,
                    datasets: [{
                        label: 'Average Lead Time (Days)',
                        data: trends.avg_lead_times,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            });
        }

        async function predictDeliveryTime() {
            const carrier = document.getElementById('predictCarrier').value;
            const orderValue = document.getElementById('predictValue').value;
            
            try {
                const response = await fetch(`/api/predict-delivery?carrier=${carrier}&order_value=${orderValue}`);
                const prediction = await response.json();
                
                document.getElementById('predictionResult').innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 4px; border: 1px solid #ddd;">
                        <strong>Predicted Delivery Time:</strong> ${prediction.predicted_days} days<br>
                        <strong>Confidence:</strong> ${prediction.confidence}<br>
                        <strong>Range:</strong> ${prediction.min_expected} - ${prediction.max_expected} days<br>
                        <small>${prediction.reasoning}</small>
                    </div>
                `;
            } catch (error) {
                document.getElementById('predictionResult').innerHTML = 'Error getting prediction';
            }
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDeliveryDashboard);
        
        // Refresh every 2 minutes
        setInterval(loadDeliveryDashboard, 120000);
    </script>
</body>
</html>